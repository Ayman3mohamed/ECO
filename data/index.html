<!DOCTYPE html>
<html>
<head>
	<title>Lacuna oracle master</title>
	<style type="text/css">
	#log {
		position: absolute;
		height: 95%;
	}

	#control {
		position: fixed;
		bottom: 0px;
		left: 1px;

		width:98%;
		padding: 10px;
		border:solid 1px;
	}

	#send {
		position: relative;
		margin-left: 20px;
	}

	#input {
		width: 700px;
		position: relative;
		top: 7px;
	}

	#question {
		width:100%;
		min-height: 40px;
		border:solid 1px;
		margin-bottom: 15px;
	}

	#doron {
	}
	</style>
</head>
<body>
<div id="log"></div>
<div id="control">
	<div id="question"></div>

	<button onclick="intercept()">Intercept</button>
	<textarea rows="1" cols="50" id="input"></textarea>
	<button id="send" onclick="send()">send</button>

</div>

<script type="text/javascript">

	var xhr;
	var permanent_request;

	function getLog() {
		call("getLog",function() {
			if (xhr.readyState == 4 && xhr.status === 200) {
				var lines = JSON.parse(xhr.responseText).text.split("|||");
				var logs = document.getElementById("log");
				for(var i = 0; i < lines.length; i++) {
					var lineDiv = document.createElement("div");
					lineDiv.innerHTML = lines[i];
					document.body.appendChild(lineDiv);
				}
			}
		});
	}

	function intercept() {
		call("intercept",function() {
			if (xhr.readyState == 4 && xhr.status === 200) {
				var status = JSON.parse(xhr.responseText).status;
				if(status == "okay") {
					document.getElementById("question").style.backgroundColor = "#A07070";
					permanent_request = setInterval(requestInput, 500);
				}
			}
		});
	}

	function requestInput() {
		call("intercept",function() {
			if (xhr.readyState == 4 && xhr.status === 200) {
				//console.log("response:" ,xhr.responseText);
				var text = JSON.parse(xhr.responseText).text;
				if(text !== "") {
					clearInterval(permanent_request);
					document.getElementById("question").style.backgroundColor = "#809070";
					document.getElementById("question").innerHTML = text;
				}
			}
		},'{requestInput:'+"0"+'}');
	}

	function send() {
		var responseText = document.getElementById("input").value;
		call("intercept",function() {
			if (xhr.readyState == 4 && xhr.status === 200) {
				//console.log("response:" ,xhr.responseText);
				//var text = JSON.parse(xhr.responseText).text;
				document.getElementById("question").style.backgroundColor = "white";
				document.getElementById("question").innerHTML = "";
				document.getElementById("input").value = "";
			}
		},'{response:'+responseText+'}');
	}

	function call(url,fct,json) {
		console.log(json);
		xhr = new XMLHttpRequest();
		xhr.open('PUT', url);
		xhr.setRequestHeader('Content-Type', 'application/json');
		xhr.onload = fct;
		if(json === undefined)
			xhr.send();
		else {
			//console.log("sending: "+","+json);
			//xhr.send('{requestNumber:'+"5"+'}');
			xhr.send(json);
		}
	}

	getLog();
</script>
</body>
</html>